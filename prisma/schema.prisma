generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  phone         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  role       String?   @default("user")
  banned     Boolean?  @default(false)
  banReason  String?
  banExpires DateTime?

  // Relations
  sessions  Session[]
  accounts  Account[]
  orders    Order[]
  addresses Address[]
  wishlist  WishlistItem[]
  cart      CartItem[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String? 
  userAgent String? 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String? 
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String 
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  price       Float 
  stock       Int
  image       String? 

  // Technical Specifications
  brand          String?
  sku            String? @unique
  dpi            String?
  weight         String?
  connectionType String?
  pollingRate    String?
  sensor         String?
  warranty       String?
  availability   String? @default("In Stock")

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  orderItems    OrderItem[]
  wishlistItems WishlistItem[]
  cartItems     CartItem[]
  category      Category?      @relation(fields: [categoryId], references: [id])
  categoryId    String?
  colors        String[]       @default([])
  switchType    String?

  isActive    Boolean   @default(true)
  scheduledAt DateTime?

  specs Json? @default("{}")

  reservations StockReservation[]

  @@map("products")
}

model StockReservation {
  id        String   @id @default(cuid())
  productId String
  userId    String? 
  quantity  Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@index([productId, expiresAt])
  @@map("stock_reservations")
}

// 1. Enums
enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  COD
  STRIPE
}

enum CouponType {
  PERCENTAGE
  FIXED
}

// 2. Order Model
model Order {
  id          String  @id @default(cuid())
  orderNumber String  @unique
  userId      String?
  user        User?   @relation(fields: [userId], references: [id])

  name    String 
  email   String? 
  phone   String 
  address String 

  totalAmount    Float
  discountAmount Float @default(0)
  status         OrderStatus @default(PENDING)

  paymentMethod PaymentMethod @default(COD)
  paymentStatus PaymentStatus @default(PENDING)

  stripePaymentIntentId String? @unique

  coupon   Coupon? @relation(fields: [couponId], references: [id])
  couponId String?

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("orders")
}

// 3. Order Item Model
model OrderItem {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  name     String
  price    Float
  quantity Int
  image    String?

  @@map("order_items")
}

model Category {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique 
  description String? @db.Text 
  image       String? 

  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  isActive   Boolean @default(true) 
  isFeatured Boolean @default(false) 

  seoTitle       String?
  seoDescription String?

  products Product[] 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId]) 
}

model SiteSettings {
  id           String    @id @default("general")
  topBarText   String?
  topBarLink   String? 
  topBarActive Boolean   @default(true)
  topBarStart  DateTime?
  topBarEnd    DateTime?
  maintenanceMode Boolean @default(false)

  updatedAt DateTime @updatedAt

  @@map("site_settings")
}

model Coupon {
  id         String   @id @default(cuid())
  code       String   @unique
  type       CouponType
  value      Float
  expiresAt  DateTime
  isActive   Boolean  @default(true)
  usageLimit Int?
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  orders     Order[]

  @@map("coupons")
}

model HeroSlide {
  id       String  @id @default(cuid())
  title    String
  subtitle String?
  image    String 
  link     String?
  order    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hero_slides")
}

model Address {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name    String
  phone   String
  street  String
  city    String
  state   String?
  zip     String
  country String  @default("Bangladesh")

  isDefault Boolean @default(false)
  type      String  @default("HOME") 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@map("cart_items")
}
